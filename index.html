<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Infographic Extravaganza – Projets AFD</title>
  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <!-- Animation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --background-color: #f5f6fa;
      --card-background: #ffffff;
      --gradient-start: #2980b9;
      --gradient-end: #6dd5fa;
      --success-color: #2ecc71;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --info-color: #3498db;
      --chart-color-1: rgba(52, 152, 219, 0.7);
      --chart-color-2: rgba(46, 204, 113, 0.7);
      --chart-color-3: rgba(231, 76, 60, 0.7);
      --chart-color-4: rgba(241, 196, 15, 0.7);
      --chart-color-5: rgba(155, 89, 182, 0.7);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--background-color) 0%, #e0e4f5 100%);
      padding: 20px;
      min-height: 100vh;
      overflow-x: hidden;
      color: var(--primary-color);
    }
    /* Navigation Bar */
    .navbar {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      padding: 10px;
      border-radius: 10px;
      z-index: 100;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .navbar a {
      text-decoration: none;
      color: var(--primary-color);
      font-weight: bold;
      padding: 10px 15px;
      border-radius: 5px;
      transition: all 0.3s;
    }
    .navbar a:hover {
      background: var(--secondary-color);
      color: #fff;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(52,152,219,0.2);
    }
    .navbar a.active {
      background: var(--secondary-color);
      color: white;
    }
    .dashboard { max-width: 1200px; margin: 0 auto; }
    /* Particles background */
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0; left: 0;
      z-index: -1;
    }
    .header {
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      color: white;
      position: relative;
      overflow: hidden;
    }
    .header::after {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.5;
      z-index: 0;
    }
    .header-content { position: relative; z-index: 1; }
    .header h1 { 
      font-size: 2.2rem; 
      margin-bottom: 10px; 
      text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: var(--card-background);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .stat-card:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }
    .stat-card::after {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 5px;
      background: linear-gradient(90deg, var(--secondary-color), var(--gradient-end));
    }
    .stat-card h3 {
      font-size: 1.2rem;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--secondary-color);
      margin-top: 15px;
      display: flex;
      align-items: baseline;
    }
    .stat-value .trend { font-size: 1rem; margin-left: 10px; }
    .trend.up { color: var(--success-color); }
    .trend.down { color: var(--danger-color); }
    .chart-container {
      background: var(--card-background);
      padding: 25px;
      border-radius: 15px;
      margin: 30px 0;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      height: 500px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .chart-container:hover { 
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }
    .chart-container h3 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: var(--primary-color);
      text-align: center;
    }
    .table-container {
      background: var(--card-background);
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      overflow-x: auto;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      margin-bottom: 40px;
    }
    .table-container:hover { 
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    th, td { 
      padding: 15px; 
      text-align: left; 
      border-bottom: 1px solid #eee; 
    }
    th { 
      background: var(--primary-color); 
      color: white; 
      position: sticky; 
      top: 0; 
      z-index: 10; 
    }
    tr { transition: background-color 0.3s ease; }
    tr:hover { background-color: #f5f9ff !important; }
    tr:nth-child(even) { background: #f8f9fa; }
    .filters-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .search-container { 
      flex: 1;
      display: flex;
      gap: 15px;
      min-width: 250px;
    }
    .search-input {
      flex: 1; 
      padding: 12px 20px;
      border: 2px solid #eee; 
      border-radius: 30px; 
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .search-input:focus { 
      border-color: var(--secondary-color); 
      outline: none; 
      box-shadow: 0 5px 15px rgba(52,152,219,0.1);
    }
    select {
      padding: 12px 20px; 
      border: 2px solid #eee; 
      border-radius: 30px;
      font-size: 16px; 
      background-color: white; 
      cursor: pointer; 
      transition: all 0.3s ease;
      flex-shrink: 0;
      min-width: 180px;
    }
    select:focus { 
      border-color: var(--secondary-color); 
      outline: none; 
    }
    .number-cell { 
      text-align: right; 
      font-variant-numeric: tabular-nums; 
    }
    /* File input styling */
    .file-input {
      margin: 20px 0; 
      padding: 30px; 
      background: white; 
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
      text-align: center; 
      transition: all 0.3s ease;
      border: 2px dashed #ddd;
    }
    .file-input:hover { 
      border-color: var(--secondary-color);
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
    }
    .file-input-label {
      display: inline-block; 
      padding: 12px 30px;
      background: var(--secondary-color); 
      color: white; 
      border-radius: 30px;
      cursor: pointer; 
      transition: all 0.3s ease; 
      margin-top: 15px; 
      font-weight: 600;
    }
    .file-input-label:hover {
      background: #2980b9; 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52,152,219,0.2);
    }
    #csvFile { display: none; }
    .loading {
      text-align: center; 
      padding: 50px 20px; 
      font-size: 1.2em; 
      color: var(--secondary-color);
    }
    .loader {
      display: inline-block; 
      position: relative; 
      width: 80px; 
      height: 80px; 
      margin-bottom: 20px;
    }
    .loader div {
      position: absolute; 
      top: 33px; 
      width: 13px; 
      height: 13px; 
      border-radius: 50%;
      background: var(--secondary-color); 
      animation-timing-function: cubic-bezier(0,1,1,0);
    }
    .loader div:nth-child(1) { left: 8px; animation: loader1 0.6s infinite; }
    .loader div:nth-child(2) { left: 8px; animation: loader2 0.6s infinite; }
    .loader div:nth-child(3) { left: 32px; animation: loader2 0.6s infinite; }
    .loader div:nth-child(4) { left: 56px; animation: loader3 0.6s infinite; }
    @keyframes loader1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    @keyframes loader2 { 0% { transform: translate(0,0); } 100% { transform: translate(24px,0); } }
    @keyframes loader3 { 0% { transform: scale(1); } 100% { transform: scale(0); } }
    /* Animated table rows */
    .table-row-animation { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Additional styling for better visualization */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
    }
    .chart-wrapper {
      position: relative;
      height: 450px;
    }
    .tag {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-right: 5px;
      background: var(--secondary-color);
      color: white;
    }
    .tag.execution { background: var(--info-color); }
    .tag.completed { background: var(--success-color); }
    .tag.planning { background: var(--warning-color); }
    .tag.cancelled { background: var(--danger-color); }
    
    .detail-row {
      display: none;
      background: #f8f9fa;
      padding: 15px;
      border-bottom: 1px solid #eee;
      animation: fadeIn 0.3s ease;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    .detail-item {
      margin-bottom: 10px;
    }
    .detail-item strong {
      display: block;
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 5px;
    }
    .show-details-btn {
      background: none;
      border: none;
      color: var(--secondary-color);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 5px;
      transition: all 0.3s ease;
    }
    .show-details-btn:hover {
      color: var(--primary-color);
      transform: scale(1.1);
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .pagination button {
      padding: 8px 15px;
      border: none;
      background: var(--secondary-color);
      color: white;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .pagination button:hover {
      background: var(--primary-color);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .pagination button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .page-info {
      margin-top: 10px;
      text-align: center;
      color: #666;
    }
    .filter-pill {
      display: inline-flex;
      align-items: center;
      background: #f1f1f1;
      padding: 5px 10px;
      border-radius: 20px;
      margin-right: 10px;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
    .filter-pill span {
      margin-right: 5px;
    }
    .filter-pill button {
      background: none;
      border: none;
      color: var(--danger-color);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .active-filters {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }
    .hidden {
      display: none !important;
    }
    .expandable-cell {
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: var(--primary-color);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      .chart-grid {
        grid-template-columns: 1fr;
      }
      .filters-container {
        flex-direction: column;
      }
      .stat-card {
        padding: 15px;
      }
      .stat-value {
        font-size: 2rem;
      }
      .navbar {
        justify-content: flex-start;
        overflow-x: auto;
        padding: 10px 5px;
      }
      .navbar a {
        padding: 8px 12px;
        font-size: 0.9rem;
      }
      th, td {
        padding: 10px;
      }
    }
    .extra-stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .mini-stat {
      background: var(--card-background);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    .mini-stat:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .mini-stat .icon {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--secondary-color);
    }
    .mini-stat .value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    .mini-stat .label {
      font-size: 0.9rem;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="#stats" class="active">Stats</a>
    <a href="#extra-stats">Stats Avancées</a>
    <a href="#charts">Graphiques</a>
    <a href="#regions">Régions</a>
    <a href="#sectors">Secteurs</a>
    <a href="#timeline">Chronologie</a>
    <a href="#table">Tableau</a>
    <a href="#budget-country">Budget par Pays</a>
  </nav>
  <div id="particles-js"></div>
  <div class="dashboard">
    <div class="header" data-aos="fade-down" data-aos-duration="1000">
      <div class="header-content">
        <h1 class="animate__animated animate__fadeInDown">Infographic Extravaganza – Projets AFD</h1>
        <p class="animate__animated animate__fadeInUp">Analyse approfondie de tous les projets : financements, dates, localisations et bien plus…</p>
      </div>
    </div>

    <div class="file-input" data-aos="fade-up" data-aos-duration="800">
      <i class="fas fa-file-csv fa-3x" style="color: var(--secondary-color); margin-bottom: 15px;"></i>
      <h3>Importez vos données</h3>
      <p>Sélectionnez votre fichier CSV (données complètes des projets AFD)</p>
      <input type="file" id="csvFile" accept=".csv">
      <label for="csvFile" class="file-input-label">
        <i class="fas fa-upload"></i> Choisir un fichier
      </label>
    </div>

    <div id="loading" class="loading" style="display:none;">
      <div class="loader"><div></div><div></div><div></div><div></div></div>
      <p>Traitement des données en cours...</p>
    </div>

    <div id="dashboard-content" style="display:none;">
      <!-- Basic Stats Section -->
      <section id="stats" class="stats-container">
        <div class="stat-card" data-aos="zoom-in" data-aos-delay="100">
          <h3><i class="fas fa-euro-sign" style="color: var(--secondary-color);"></i> Budget Total</h3>
          <div id="totalBudget" class="stat-value"></div>
        </div>
        <div class="stat-card" data-aos="zoom-in" data-aos-delay="200">
          <h3><i class="fas fa-tasks" style="color: var(--secondary-color);"></i> Nombre de Projets</h3>
          <div id="projectCount" class="stat-value"></div>
        </div>
        <div class="stat-card" data-aos="zoom-in" data-aos-delay="300">
          <h3><i class="fas fa-chart-line" style="color: var(--secondary-color);"></i> Budget Moyen</h3>
          <div id="avgBudget" class="stat-value"></div>
        </div>
        <div class="stat-card" data-aos="zoom-in" data-aos-delay="400">
          <h3><i class="fas fa-globe-europe" style="color: var(--secondary-color);"></i> Pays Couverts</h3>
          <div id="countryCount" class="stat-value"></div>
        </div>
      </section>

      <!-- Extra Stats Section -->
      <section id="extra-stats">
        <h3 style="text-align:center; margin-bottom:20px; font-size:1.8rem; color:var(--primary-color);">Statistiques Avancées</h3>
        <div class="extra-stats-container">
          <div class="mini-stat" data-aos="fade-up" data-aos-delay="100">
            <div class="icon"><i class="fas fa-hourglass-half"></i></div>
            <div id="projectsInExecution" class="value">0</div>
            <div class="label">Projets en Exécution</div>
          </div>
          <div class="mini-stat" data-aos="fade-up" data-aos-delay="150">
            <div class="icon"><i class="fas fa-check-circle"></i></div>
            <div id="projectsCompleted" class="value">0</div>
            <div class="label">Projets Achevés</div>
          </div>
          <div class="mini-stat" data-aos="fade-up" data-aos-delay="200">
            <div class="icon"><i class="fas fa-handshake"></i></div>
            <div id="cofinancedProjects" class="value">0</div>
            <div class="label">Projets Cofinancés</div>
          </div>
          <div class="mini-stat" data-aos="fade-up" data-aos-delay="250">
            <div class="icon"><i class="fas fa-calendar-alt"></i></div>
            <div id="avgProjectDuration" class="value">0</div>
            <div class="label">Durée Moyenne (années)</div>
          </div>
          <div class="mini-stat" data-aos="fade-up" data-aos-delay="300">
            <div class="icon"><i class="fas fa-building"></i></div>
            <div id="publicEntities" class="value">0</div>
            <div class="label">Entités Publiques</div>
          </div>
          <div class="mini-stat" data-aos="fade-up" data-aos-delay="350">
            <div class="icon"><i class="fas fa-users"></i></div>
            <div id="privateEntities" class="value">0</div>
            <div class="label">Entités Privées</div>
          </div>
        </div>
      </section>

      <!-- Charts Section -->
      <section id="charts">
        <h3 style="text-align:center; margin-bottom:20px; font-size:1.8rem; color:var(--primary-color);">Graphiques</h3>
        <div class="chart-grid">
          <!-- Bar Chart: Top Projects by Budget -->
          <div class="chart-container" data-aos="fade-up" data-aos-duration="1000">
            <h3>Top 10 des Projets par Budget</h3>
            <div class="chart-wrapper">
              <canvas id="barChart"></canvas>
            </div>
          </div>
          
          <!-- Pie Chart: Projects by State -->
          <div class="chart-container" data-aos="fade-up" data-aos-duration="1000">
            <h3>Répartition des Projets par État</h3>
            <div class="chart-wrapper">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Line Chart: Project Evolution by Year -->
        <div class="chart-container" data-aos="fade-up" data-aos-duration="1000">
          <h3>Évolution des Projets par Année</h3>
          <div class="chart-wrapper">
            <canvas id="lineChart"></canvas>
          </div>
        </div>
      </section>

      <!-- Regions Section -->
      <section id="regions">
        <h3 style="text-align:center; margin-bottom:20px; font-size:1.8rem; color:var(--primary-color);">Répartition par Région</h3>
        <div class="chart-container" data-aos="fade-up" data-aos-duration="1000">
          <div class="chart-wrapper">
            <canvas id="regionChart"></canvas>
          </div>
        </div>
      </section>

      <!-- Sectors Section -->
      <section id="sectors">
        <h3 style="text-align:center; margin-bottom:20px; font-size:1.8rem; color:var(--primary-color);">Répartition par Secteur</h3>
        <div class="chart-container" data-aos="fade-up" data-aos-duration="1000">
          <div class="chart-wrapper">
            <canvas id="sectorChart"></canvas>
          </div>
        </div>
      </section>

      <!-- Timeline Section -->
      <section id="timeline">
        <h3 style="text-align:center; margin-bottom:20px; font-size:1.8rem; color:var(--primary-color);">Chronologie des Projets</h3>
        <div class="chart-container" data-aos="fade-up" data-aos-duration="1000">
          <div class="chart-wrapper">
            <canvas id="timelineChart"></canvas>
          </div>
        </div>
      </section>

      <!-- Main Table Section -->
      <section id="table" class="table-container" data-aos="fade-up" data-aos-duration="1000">
        <div class="filters-container">
          <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Rechercher par titre, pays, secteur...">
            <select id="sortField">
              <option value="title-asc">Titre A-Z</option>
              <option value="title-desc">Titre Z-A</option>
              <option value="budget-desc" selected>Budget (décroissant)</option>
              <option value="budget-asc">Budget (croissant)</option>
              <option value="date-desc">Date d'octroi (récent)</option>
              <option value="date-asc">Date d'octroi (ancien)</option>
            </select>
          </div>
          <select id="stateFilter">
            <option value="all">Tous les états</option>
            <!-- Options ajoutées dynamiquement -->
          </select>
          <select id="countryFilter">
            <option value="all">Tous les pays</option>
            <!-- Options ajoutées dynamiquement -->
          </select>
          <select id="sectorFilter">
            <option value="all">Tous les secteurs</option>
            <!-- Options ajoutées dynamiquement -->
          </select>
        </div>

        <div class="active-filters">
          <span style="margin-right:10px;font-weight:bold;">Filtres actifs:</span>
          <div id="active-filter-pills"></div>
        </div>

        <div class="table-responsive">
          <table id="dataTable">
            <thead>
              <tr>
                <th>Détails</th>
                <th>Titre du projet</th>
                <th>Budget</th>
                <th>État</th>
                <th>Pays</th>
                <th>Secteur</th>
                <th>Date d'octroi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="pagination">
          <button id="prevPage" disabled>&laquo; Précédent</button>
          <button id="nextPage">Suivant &raquo;</button>
        </div>
        <div class="page-info">
          Affichage de <span id="startIndex">1</span> à <span id="endIndex">10</span> sur <span id="totalItems">0</span> projets
        </div>
      </section>

      <!-- Table Budget par Pays Section -->
      <section id="budget-country">
        <h3 style="text-align:center; margin-bottom:20px; font-size:1.8rem; color:var(--primary-color);">Budget par Pays</h3>
        <div class="table-container" data-aos="fade-up" data-aos-duration="1000">
          <div class="table-responsive">
            <table id="budgetByCountryTable">
              <thead>
                <tr>
                  <th>Pays</th>
                  <th>Budget Total (M€)</th>
                  <th>Nombre de Projets</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Particles.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
  <script>
    // Initialize AOS and particles.js
    document.addEventListener('DOMContentLoaded', function() {
      AOS.init({ once: true });
      particlesJS('particles-js', {
        "particles": {
          "number": { "value": 50, "density": { "enable": true, "value_area": 800 } },
          "color": { "value": "#3498db" },
          "shape": { "type": "circle", "stroke": { "width": 0, "color": "#000000" } },
          "opacity": { "value": 0.1, "random": true },
          "size": { "value": 5, "random": true },
          "line_linked": { "enable": true, "distance": 150, "color": "#3498db", "opacity": 0.1, "width": 1 },
          "move": { "enable": true, "speed": 1, "direction": "none", "random": true, "straight": false, "out_mode": "out", "bounce": false }
        },
        "interactivity": {
          "detect_on": "canvas",
          "events": {
            "onhover": { "enable": true, "mode": "bubble" },
            "onclick": { "enable": true, "mode": "push" },
            "resize": true
          },
          "modes": {
            "bubble": { "distance": 200, "size": 6, "duration": 2, "opacity": 0.2, "speed": 3 },
            "push": { "particles_nb": 4 }
          }
        },
        "retina_detect": true
      });
      
      // Smooth scrolling for navbar
      document.querySelectorAll('.navbar a').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
          e.preventDefault();
          document.querySelector(this.getAttribute('href')).scrollIntoView({
            behavior: 'smooth'
          });
          document.querySelectorAll('.navbar a').forEach(a => a.classList.remove('active'));
          this.classList.add('active');
        });
      });
    });

    // Global variables
    let allData = [];
    let filteredData = [];
    let chartInstances = {};
    let currentPage = 1;
    let itemsPerPage = 10;
    let activeFilters = {
      search: '',
      state: 'all',
      country: 'all',
      sector: 'all'
    };

    // Helper functions
    function convertToMillions(value) {
      if (!value || value === '-') return 0;
      return parseFloat(value.toString().replace(',', '.')) / 1000000;
    }
    
    function formatNumber(num) {
      return num.toLocaleString('fr-FR', { maximumFractionDigits: 2 });
    }
    
    function getStatusTag(status) {
      let className = '';
      if (status.toLowerCase().includes('exécution')) className = 'execution';
      else if (status.toLowerCase().includes('achevé')) className = 'completed';
      else if (status.toLowerCase().includes('préparation')) className = 'planning';
      else if (status.toLowerCase().includes('abandon')) className = 'cancelled';
      
      return `<span class="tag ${className}">${status}</span>`;
    }

    // Process CSV data
    function processData(data) {
      return data.filter(row => row["Titre du projet"]).map(row => ({
        id: row["Id. Projet"] || row["Id. Concours"] || "",
        title: row["Titre du projet"] ? row["Titre du projet"].trim() : "Sans titre",
        description: row["Description du projet"] || "",
        state: row["Etat du projet"] ? row["Etat du projet"].trim() : "Non spécifié",
        country: row["Pays de réalisation"] ? row["Pays de réalisation"].trim() : "Non spécifié",
        region: row["Région"] ? row["Région"].trim() : "Non spécifié",
        sector: row["Libellé secteur économique  (CAD-5)"] || row["Libellé CICID"] || "Non spécifié",
        cicid: row["Libellé CICID"] || "",
        budget: row["Budget"] ? parseFloat(row["Budget"].toString().replace(',', '.')) : 0,
        budgetMillions: convertToMillions(row["Budget"]),
        dateOctroi: row["Date d'octroi"] || "",
        dateAchevement: row["Date d'achèvement opérationnel du projet"] || "",
        date1erVersement: row["Date de 1er versement (concours)"] || "",
        year: row["Date d'octroi"] ? new Date(row["Date d'octroi"]).getFullYear() : null,
        lien: row["Lien_Fiche_Projet"] || "",
        cofinanced: row["Cofinanciers (O/N)"] === "Oui",
        cofinancier: row["Cofinancier"] || "",
        beneficiary: row["Libellé bénéficiaire primaire"] || "",
        agency: row["Libellé agence"] || "",
        dateMaj: row["Date mise à jour données projet"] || "",
        datePublication: row["Date de la dernière publication"] || "",
        division: row["Division Technique"] || "",
        aidType: row["Libellé indicateur APD"] || "",
        productGroup: row["Groupe de produit"] || "",
        responsibleCountry: row["Responsable pays"] || ""
      }));
    }

    // Animated counter
    function animateCounter(element, target, duration = 2000, prefix = '', suffix = '') {
      const start = 0;
      const startTime = performance.now();
      function updateCounter(currentTime) {
        const elapsedTime = currentTime - startTime;
        const progress = Math.min(elapsedTime / duration, 1);
        const easeOutQuad = progress => 1 - (1 - progress) * (1 - progress);
        const easedProgress = easeOutQuad(progress);
        const currentValue = Math.floor(start + (target - start) * easedProgress);
        element.innerHTML = `${prefix}${formatNumber(currentValue)}${suffix}`;
        if (progress < 1) requestAnimationFrame(updateCounter);
        else element.innerHTML = `${prefix}${formatNumber(target)}${suffix}`;
      }
      requestAnimationFrame(updateCounter);
    }

    // Update Dashboard Stats
    function updateDashboard() {
      const totalBudget = allData.reduce((acc, row) => acc + (row.budgetMillions || 0), 0);
      const projectCount = allData.length;
      const avgBudget = projectCount ? totalBudget / projectCount : 0;
      const uniqueCountries = new Set(allData.map(row => row.country)).size;

      const totalBudgetEl = document.getElementById('totalBudget');
      const projectCountEl = document.getElementById('projectCount');
      const avgBudgetEl = document.getElementById('avgBudget');
      const countryCountEl = document.getElementById('countryCount');

      totalBudgetEl.innerHTML = '';
      projectCountEl.innerHTML = '';
      avgBudgetEl.innerHTML = '';
      countryCountEl.innerHTML = '';

      animateCounter(totalBudgetEl, totalBudget, 2000, '', ' M€');
      animateCounter(projectCountEl, projectCount, 1500);
      animateCounter(avgBudgetEl, avgBudget, 1800, '', ' M€');
      animateCounter(countryCountEl, uniqueCountries, 1500);

      setTimeout(() => {
        totalBudgetEl.innerHTML += `<span class="trend up animate__animated animate__fadeIn"><i class="fas fa-arrow-up"></i></span>`;
        projectCountEl.innerHTML += `<span class="trend up animate__animated animate__fadeIn"><i class="fas fa-arrow-up"></i></span>`;
        avgBudgetEl.innerHTML += `<span class="trend down animate__animated animate__fadeIn"><i class="fas fa-arrow-down"></i></span>`;
        countryCountEl.innerHTML += `<span class="trend up animate__animated animate__fadeIn"><i class="fas fa-arrow-up"></i></span>`;
      }, 2000);
      
      const projectsInExecution = allData.filter(row => row.state.toLowerCase().includes('exécution')).length;
      const projectsCompleted = allData.filter(row => row.state.toLowerCase().includes('achevé')).length;
      const cofinancedProjects = allData.filter(row => row.cofinanced).length;
      
      let totalDuration = 0;
      let projectsWithDuration = 0;
      allData.forEach(row => {
        if (row.dateOctroi && row.dateAchevement) {
          const startDate = new Date(row.dateOctroi);
          const endDate = new Date(row.dateAchevement);
          if (!isNaN(startDate) && !isNaN(endDate)) {
            const durationYears = (endDate - startDate) / (1000 * 60 * 60 * 24 * 365);
            totalDuration += durationYears;
            projectsWithDuration++;
          }
        }
      });
      const avgDuration = projectsWithDuration > 0 ? totalDuration / projectsWithDuration : 0;
      
      const publicEntities = allData.filter(row => 
        row.beneficiary && (
          row.beneficiary.includes('REPUBLIQUE') || 
          row.beneficiary.includes('ETAT') || 
          row.beneficiary.includes('MINISTERE') ||
          row.beneficiary.includes('GOUVERNEMENT')
        )
      ).length;
      
      const privateEntities = projectCount - publicEntities;
      
      document.getElementById('projectsInExecution').textContent = projectsInExecution;
      document.getElementById('projectsCompleted').textContent = projectsCompleted;
      document.getElementById('cofinancedProjects').textContent = cofinancedProjects;
      document.getElementById('avgProjectDuration').textContent = avgDuration.toFixed(1);
      document.getElementById('publicEntities').textContent = publicEntities;
      document.getElementById('privateEntities').textContent = privateEntities;
      
      updateFilterOptions();
    }

    // Update filter options
    function updateFilterOptions() {
      const states = [...new Set(allData.map(item => item.state))].filter(Boolean).sort();
      const stateFilter = document.getElementById('stateFilter');
      stateFilter.innerHTML = '<option value="all">Tous les états</option>';
      states.forEach(state => {
        const option = document.createElement('option');
        option.value = state;
        option.textContent = state;
        stateFilter.appendChild(option);
      });
      
      const countries = [...new Set(allData.map(item => item.country))].filter(Boolean).sort();
      const countryFilter = document.getElementById('countryFilter');
      countryFilter.innerHTML = '<option value="all">Tous les pays</option>';
      countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country;
        option.textContent = country;
        countryFilter.appendChild(option);
      });
      
      const sectors = [...new Set(allData.map(item => item.sector))].filter(Boolean).sort();
      const sectorFilter = document.getElementById('sectorFilter');
      sectorFilter.innerHTML = '<option value="all">Tous les secteurs</option>';
      sectors.forEach(sector => {
        const option = document.createElement('option');
        option.value = sector;
        option.textContent = sector;
        sectorFilter.appendChild(option);
      });
    }

    // Chart: Top Projects by Budget
    function updateBarChart() {
      const ctx = document.getElementById('barChart').getContext('2d');
      const validData = allData.filter(row => row.budgetMillions > 0);
      validData.sort((a, b) => b.budgetMillions - a.budgetMillions);
      const topData = validData.slice(0, 10);
      
      if(chartInstances.barChart) chartInstances.barChart.destroy();
      
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(52,152,219,0.8)');
      gradient.addColorStop(1, 'rgba(52,152,219,0.2)');
      
      chartInstances.barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topData.map(row => row.title.length > 30 ? row.title.substring(0, 30) + '...' : row.title),
          datasets: [{
            label: 'Budget (M€)',
            data: topData.map(row => row.budgetMillions),
            backgroundColor: gradient,
            borderColor: 'rgba(52,152,219,1)',
            borderWidth: 1,
            borderRadius: 5,
            barPercentage: 0.8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(44,62,80,0.9)',
              titleFont: { size: 16 },
              bodyFont: { size: 14 },
              callbacks: {
                label: function(context) {
                  return `Budget: ${formatNumber(context.parsed.x)} M€`;
                },
                title: function(context) {
                  return topData[context[0].dataIndex].title;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: 'rgba(200,200,200,0.2)' },
              title: { display: true, text: 'Budget (M€)', font: { size: 14 } }
            },
            y: { grid: { display: false } }
          },
          animation: {
            delay: (context) => context.dataIndex * 100,
            duration: 1000,
            easing: 'easeOutQuad'
          }
        }
      });
    }

    // Chart: Projects by State
    function updatePieChart() {
      const ctx = document.getElementById('pieChart').getContext('2d');
      const stateCounts = {};
      allData.forEach(row => {
        const st = row.state || "Non spécifié";
        stateCounts[st] = (stateCounts[st] || 0) + 1;
      });
      
      const labels = Object.keys(stateCounts);
      const dataValues = Object.values(stateCounts);
      
      const colors = [
        'rgba(52, 152, 219, 0.7)',
        'rgba(46, 204, 113, 0.7)',
        'rgba(231, 76, 60, 0.7)',
        'rgba(241, 196, 15, 0.7)',
        'rgba(155, 89, 182, 0.7)',
        'rgba(52, 73, 94, 0.7)',
        'rgba(230, 126, 34, 0.7)',
        'rgba(149, 165, 166, 0.7)',
        'rgba(26, 188, 156, 0.7)',
        'rgba(211, 84, 0, 0.7)'
      ];
      
      if(chartInstances.pieChart) chartInstances.pieChart.destroy();
      
      chartInstances.pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: dataValues,
            backgroundColor: colors.slice(0, labels.length),
            borderColor: colors.map(c => c.replace('0.7', '1')).slice(0, labels.length),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { padding: 20, boxWidth: 15, font: { size: 12 } }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${value} projets (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Chart: Project Evolution by Year
    function updateLineChart() {
      const ctx = document.getElementById('lineChart').getContext('2d');
      
      const yearCounts = {};
      const yearBudgets = {};
      
      allData.forEach(row => {
        if(row.year) {
          yearCounts[row.year] = (yearCounts[row.year] || 0) + 1;
          yearBudgets[row.year] = (yearBudgets[row.year] || 0) + row.budgetMillions;
        }
      });
      
      const years = Object.keys(yearCounts).sort();
      const counts = years.map(y => yearCounts[y]);
      const budgets = years.map(y => yearBudgets[y]);
      
      if(chartInstances.lineChart) chartInstances.lineChart.destroy();
      
      chartInstances.lineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [
            {
              label: 'Nombre de Projets',
              data: counts,
              fill: false,
              borderColor: 'rgba(52,152,219,1)',
              backgroundColor: 'rgba(52,152,219,0.5)',
              tension: 0.4,
              yAxisID: 'y',
              pointRadius: 5,
              pointHoverRadius: 8
            },
            {
              label: 'Budget Total (M€)',
              data: budgets,
              fill: false,
              borderColor: 'rgba(46,204,113,1)',
              backgroundColor: 'rgba(46,204,113,0.5)',
              tension: 0.4,
              yAxisID: 'y1',
              pointRadius: 5,
              pointHoverRadius: 8
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.datasetIndex === 0) {
                    return `${context.parsed.y} projets en ${context.label}`;
                  } else {
                    return `Budget: ${formatNumber(context.parsed.y)} M€ en ${context.label}`;
                  }
                }
              }
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Nombre de Projets' },
              grid: { drawOnChartArea: false }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Budget Total (M€)' },
              grid: { drawOnChartArea: false }
            },
            x: { title: { display: true, text: 'Année' } }
          }
        }
      });
    }
    
    // Chart: Regional Distribution
    function updateRegionChart() {
      const ctx = document.getElementById('regionChart').getContext('2d');
      
      const regionData = {};
      allData.forEach(row => {
        if (row.region) {
          const region = row.region;
          if (!regionData[region]) {
            regionData[region] = { count: 0, budget: 0 };
          }
          regionData[region].count += 1;
          regionData[region].budget += row.budgetMillions;
        }
      });
      
      const regions = Object.keys(regionData).sort();
      const counts = regions.map(r => regionData[r].count);
      const budgets = regions.map(r => regionData[r].budget);
      
      if(chartInstances.regionChart) chartInstances.regionChart.destroy();
      
      chartInstances.regionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: regions,
          datasets: [
            {
              label: 'Nombre de Projets',
              data: counts,
              backgroundColor: 'rgba(52,152,219,0.7)',
              borderColor: 'rgba(52,152,219,1)',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: 'Budget Total (M€)',
              data: budgets,
              backgroundColor: 'rgba(46,204,113,0.7)',
              borderColor: 'rgba(46,204,113,1)',
              borderWidth: 1,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.datasetIndex === 0) {
                    return `${context.parsed.y} projets`;
                  } else {
                    return `Budget: ${formatNumber(context.parsed.y)} M€`;
                  }
                }
              }
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: 'Nombre de Projets' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: 'Budget Total (M€)' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    // Chart: Sectoral Distribution
    function updateSectorChart() {
      const ctx = document.getElementById('sectorChart').getContext('2d');
      
      const sectorData = {};
      allData.forEach(row => {
        if (row.sector) {
          const sector = row.sector || "Non spécifié";
          if (!sectorData[sector]) {
            sectorData[sector] = { count: 0, budget: 0 };
          }
          sectorData[sector].count += 1;
          sectorData[sector].budget += row.budgetMillions;
        }
      });
      
      const sortedSectors = Object.entries(sectorData)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 10);
      
      const sectors = sortedSectors.map(s => s[0]);
      const counts = sortedSectors.map(s => s[1].count);
      const budgets = sortedSectors.map(s => s[1].budget);
      
      if(chartInstances.sectorChart) chartInstances.sectorChart.destroy();
      
      chartInstances.sectorChart = new Chart(ctx, {
        type: 'polarArea',
        data: {
          labels: sectors,
          datasets: [{
            data: budgets,
            backgroundColor: [
              'rgba(52, 152, 219, 0.7)',
              'rgba(46, 204, 113, 0.7)',
              'rgba(231, 76, 60, 0.7)', 
              'rgba(241, 196, 15, 0.7)',
              'rgba(155, 89, 182, 0.7)',
              'rgba(52, 73, 94, 0.7)',  
              'rgba(230, 126, 34, 0.7)',
              'rgba(149, 165, 166, 0.7)',
              'rgba(26, 188, 156, 0.7)', 
              'rgba(211, 84, 0, 0.7)'
            ],
            borderColor: [
              'rgba(52, 152, 219, 1)',
              'rgba(46, 204, 113, 1)',
              'rgba(231, 76, 60, 1)', 
              'rgba(241, 196, 15, 1)',
              'rgba(155, 89, 182, 1)',
              'rgba(52, 73, 94, 1)',  
              'rgba(230, 126, 34, 1)',
              'rgba(149, 165, 166, 1)',
              'rgba(26, 188, 156, 1)', 
              'rgba(211, 84, 0, 1)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { font: { size: 11 } }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const sectorIndex = sectors.indexOf(context.label);
                  const projectCount = counts[sectorIndex];
                  const budget = budgets[sectorIndex];
                  return [`Budget: ${formatNumber(budget)} M€`, `Projets: ${projectCount}`];
                }
              }
            }
          }
        }
      });
    }

    // Chart: Timeline of Projects
    function updateTimelineChart() {
      const ctx = document.getElementById('timelineChart').getContext('2d');
      
      const dataSeries = {};
      allData.forEach(row => {
        if (row.year) {
          const state = row.state || "Non spécifié";
          if (!dataSeries[state]) {
            dataSeries[state] = {};
          }
          dataSeries[state][row.year] = (dataSeries[state][row.year] || 0) + 1;
        }
      });
      
      let allYears = [];
      Object.values(dataSeries).forEach(yearObj => {
        allYears = [...allYears, ...Object.keys(yearObj)];
      });
      allYears = [...new Set(allYears)].sort();
      
      const states = Object.keys(dataSeries);
      
      const colors = [
        'rgba(52, 152, 219, 0.7)',
        'rgba(46, 204, 113, 0.7)',
        'rgba(231, 76, 60, 0.7)', 
        'rgba(241, 196, 15, 0.7)',
        'rgba(155, 89, 182, 0.7)',
        'rgba(52, 73, 94, 0.7)',  
        'rgba(230, 126, 34, 0.7)',
        'rgba(149, 165, 166, 0.7)',
        'rgba(26, 188, 156, 0.7)', 
        'rgba(211, 84, 0, 0.7)'
      ];
      
      const datasets = states.map((state, index) => {
        const data = allYears.map(year => dataSeries[state][year] || 0);
        return {
          label: state,
          data: data,
          backgroundColor: colors[index % colors.length],
          borderColor: colors[index % colors.length].replace('0.7', '1'),
          borderWidth: 1
        };
      });
      
      if(chartInstances.timelineChart) chartInstances.timelineChart.destroy();
      
      chartInstances.timelineChart = new Chart(ctx, {
        type: 'line',
        data: { labels: allYears, datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { tooltip: { mode: 'index', intersect: false } },
          scales: {
            y: { stacked: false, title: { display: true, text: 'Nombre de Projets' } },
            x: { title: { display: true, text: 'Année' } }
          }
        }
      });
    }

    // Sort data globally sur filteredData et rafraîchit le tableau principal
    function sortData() {
      const sortField = document.getElementById('sortField').value;
      switch(sortField) {
        case 'budget-desc':
          filteredData.sort((a, b) => b.budgetMillions - a.budgetMillions);
          break;
        case 'budget-asc':
          filteredData.sort((a, b) => a.budgetMillions - b.budgetMillions);
          break;
        case 'title-asc':
          filteredData.sort((a, b) => a.title.localeCompare(b.title));
          break;
        case 'title-desc':
          filteredData.sort((a, b) => b.title.localeCompare(a.title));
          break;
        case 'date-desc':
          filteredData.sort((a, b) => {
            const dateA = a.dateOctroi ? new Date(a.dateOctroi) : new Date(0);
            const dateB = b.dateOctroi ? new Date(b.dateOctroi) : new Date(0);
            return dateB - dateA;
          });
          break;
        case 'date-asc':
          filteredData.sort((a, b) => {
            const dateA = a.dateOctroi ? new Date(a.dateOctroi) : new Date(0);
            const dateB = b.dateOctroi ? new Date(b.dateOctroi) : new Date(0);
            return dateA - dateB;
          });
          break;
      }
      populateTable();
    }

    // Populate main project table with pagination
    function populateTable() {
      const tbody = document.querySelector('#dataTable tbody');
      const totalItems = filteredData.length;
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
      const pageData = filteredData.slice(startIndex, endIndex);
      
      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = endIndex >= totalItems;
      document.getElementById('startIndex').textContent = totalItems === 0 ? 0 : startIndex + 1;
      document.getElementById('endIndex').textContent = endIndex;
      document.getElementById('totalItems').textContent = totalItems;
      
      gsap.to(tbody, {
        opacity: 0, 
        y: 10, 
        duration: 0.2,
        onComplete: () => {
          tbody.innerHTML = '';
          if (pageData.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="7" style="text-align:center;">Aucun projet ne correspond aux critères de recherche</td>`;
            tbody.appendChild(tr);
            gsap.to(tbody, { opacity: 1, y: 0, duration: 0.2 });
            return;
          }
          pageData.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.className = 'table-row-animation';
            tr.style.opacity = 0;
            tr.style.transform = 'translateY(10px)';
            let formattedDate = row.dateOctroi || '-';
            tr.innerHTML = `
              <td>
                <button id="btn-${row.id}" class="show-details-btn" onclick="toggleDetails('${row.id}')">
                  <i class="fas fa-plus-circle"></i>
                </button>
              </td>
              <td class="expandable-cell" title="${row.title}">
                ${row.lien ? `<a href="${row.lien}" target="_blank">${row.title}</a>` : row.title}
              </td>
              <td class="number-cell">${row.budget ? formatNumber(row.budgetMillions) + ' M€' : '-'}</td>
              <td>${getStatusTag(row.state)}</td>
              <td>${row.country}</td>
              <td>${row.sector}</td>
              <td>${formattedDate}</td>
            `;
            tbody.appendChild(tr);
            const detailTr = document.createElement('tr');
            detailTr.id = `details-${row.id}`;
            detailTr.className = 'detail-row';
            detailTr.style.display = 'none';
            const detailContent = `
              <td colspan="7">
                <div class="detail-grid">
                  ${row.description ? `
                    <div class="detail-item" style="grid-column: span 2;">
                      <strong>Description</strong>
                      <div>${row.description}</div>
                    </div>
                  ` : ''}
                  <div class="detail-item">
                    <strong>ID du Projet</strong>
                    <div>${row.id}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Région</strong>
                    <div>${row.region}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Date d'octroi</strong>
                    <div>${row.dateOctroi || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Date de 1er versement</strong>
                    <div>${row.date1erVersement || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Date d'achèvement</strong>
                    <div>${row.dateAchevement || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Agence</strong>
                    <div>${row.agency || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Cofinancé</strong>
                    <div>${row.cofinanced ? 'Oui' : 'Non'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Cofinancier</strong>
                    <div>${row.cofinancier || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Bénéficiaire</strong>
                    <div>${row.beneficiary || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Division Technique</strong>
                    <div>${row.division || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Type d'aide</strong>
                    <div>${row.aidType || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Groupe de produit</strong>
                    <div>${row.productGroup || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Responsable pays</strong>
                    <div>${row.responsibleCountry || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Date de mise à jour</strong>
                    <div>${row.dateMaj || '-'}</div>
                  </div>
                  <div class="detail-item">
                    <strong>Date de publication</strong>
                    <div>${row.datePublication || '-'}</div>
                  </div>
                </div>
              </td>
            `;
            detailTr.innerHTML = detailContent;
            tbody.appendChild(detailTr);
            gsap.to(tr, { opacity: 1, y: 0, duration: 0.3, delay: index * 0.03 });
          });
          gsap.to(tbody, { opacity: 1, y: 0, duration: 0.2 });
        }
      });
    }

    // Toggle row details
    function toggleDetails(rowId) {
      const detailRow = document.getElementById(`details-${rowId}`);
      if (detailRow.style.display === 'table-row') {
        detailRow.style.display = 'none';
        document.getElementById(`btn-${rowId}`).innerHTML = '<i class="fas fa-plus-circle"></i>';
      } else {
        detailRow.style.display = 'table-row';
        document.getElementById(`btn-${rowId}`).innerHTML = '<i class="fas fa-minus-circle"></i>';
      }
    }

    // Apply filters et tri sur l'ensemble des projets filtrés
    function applyFilters() {
      currentPage = 1;
      filteredData = [...allData];
      
      if (activeFilters.search) {
        const searchTerm = activeFilters.search.toLowerCase();
        filteredData = filteredData.filter(item => 
          item.title.toLowerCase().includes(searchTerm) ||
          item.country.toLowerCase().includes(searchTerm) ||
          item.sector.toLowerCase().includes(searchTerm) ||
          (item.description && item.description.toLowerCase().includes(searchTerm))
        );
      }
      
      if (activeFilters.state !== 'all') {
        filteredData = filteredData.filter(item => item.state === activeFilters.state);
      }
      
      if (activeFilters.country !== 'all') {
        filteredData = filteredData.filter(item => item.country === activeFilters.country);
      }
      
      if (activeFilters.sector !== 'all') {
        filteredData = filteredData.filter(item => item.sector === activeFilters.sector);
      }
      
      updateFilterPills();
      // Appliquer le tri global sur tous les projets filtrés
      sortData();
    }

    // Update filter pills
    function updateFilterPills() {
      const pillsContainer = document.getElementById('active-filter-pills');
      pillsContainer.innerHTML = '';
      
      const hasActiveFilters = activeFilters.search || activeFilters.state !== 'all' || activeFilters.country !== 'all' || activeFilters.sector !== 'all';
      if (!hasActiveFilters) {
        pillsContainer.innerHTML = '<span>Aucun</span>';
        return;
      }
      
      if (activeFilters.search) {
        const pill = document.createElement('div');
        pill.className = 'filter-pill';
        pill.innerHTML = `
          <span>Recherche: ${activeFilters.search}</span>
          <button data-filter="search"><i class="fas fa-times"></i></button>
        `;
        pillsContainer.appendChild(pill);
      }
      
      if (activeFilters.state !== 'all') {
        const pill = document.createElement('div');
        pill.className = 'filter-pill';
        pill.innerHTML = `
          <span>État: ${activeFilters.state}</span>
          <button data-filter="state"><i class="fas fa-times"></i></button>
        `;
        pillsContainer.appendChild(pill);
      }
      
      if (activeFilters.country !== 'all') {
        const pill = document.createElement('div');
        pill.className = 'filter-pill';
        pill.innerHTML = `
          <span>Pays: ${activeFilters.country}</span>
          <button data-filter="country"><i class="fas fa-times"></i></button>
        `;
        pillsContainer.appendChild(pill);
      }
      
      if (activeFilters.sector !== 'all') {
        const pill = document.createElement('div');
        pill.className = 'filter-pill';
        pill.innerHTML = `
          <span>Secteur: ${activeFilters.sector}</span>
          <button data-filter="sector"><i class="fas fa-times"></i></button>
        `;
        pillsContainer.appendChild(pill);
      }
      
      document.querySelectorAll('.filter-pill button').forEach(button => {
        button.addEventListener('click', function() {
          const filterType = this.dataset.filter;
          if (filterType === 'search') {
            activeFilters.search = '';
            document.getElementById('searchInput').value = '';
          } else {
            activeFilters[filterType] = 'all';
            document.getElementById(`${filterType}Filter`).value = 'all';
          }
          applyFilters();
        });
      });
    }

    // Populate table Budget par Pays
    function populateBudgetByCountryTable() {
      const tableBody = document.querySelector('#budgetByCountryTable tbody');
      tableBody.innerHTML = '';
      
      const countryData = {};
      allData.forEach(row => {
        const country = row.country || 'Non spécifié';
        if (!countryData[country]) {
          countryData[country] = { budget: 0, count: 0 };
        }
        countryData[country].budget += row.budgetMillions;
        countryData[country].count += 1;
      });
      
      const aggregatedData = Object.entries(countryData)
        .map(([country, data]) => ({ country, budget: data.budget, count: data.count }))
        .sort((a, b) => b.budget - a.budget);
      
      aggregatedData.forEach(entry => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${entry.country}</td>
          <td class="number-cell">${formatNumber(entry.budget)} M€</td>
          <td class="number-cell">${entry.count}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('searchInput').addEventListener('keyup', function() {
        activeFilters.search = this.value.trim();
        applyFilters();
      });
      
      document.getElementById('stateFilter').addEventListener('change', function() {
        activeFilters.state = this.value;
        applyFilters();
      });
      
      document.getElementById('countryFilter').addEventListener('change', function() {
        activeFilters.country = this.value;
        applyFilters();
      });
      
      document.getElementById('sectorFilter').addEventListener('change', function() {
        activeFilters.sector = this.value;
        applyFilters();
      });
      
      document.getElementById('sortField').addEventListener('change', function() {
        sortData();
      });
      
      document.getElementById('prevPage').addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          populateTable();
        }
      });
      
      document.getElementById('nextPage').addEventListener('click', function() {
        if (currentPage * itemsPerPage < filteredData.length) {
          currentPage++;
          populateTable();
        }
      });
      
      document.querySelector('.file-input-label').addEventListener('mouseenter', function() {
        gsap.to(this, { y: -3, boxShadow: '0 10px 20px rgba(52,152,219,0.3)', duration: 0.3 });
      });
      
      document.querySelector('.file-input-label').addEventListener('mouseleave', function() {
        gsap.to(this, { y: 0, boxShadow: '0 5px 15px rgba(52,152,219,0.2)', duration: 0.3 });
      });
    });

    // File input and CSV parsing
    document.getElementById('csvFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('dashboard-content').style.display = 'none';
        window.scrollTo({ top: document.getElementById('loading').offsetTop - 100, behavior: 'smooth' });
        
        Papa.parse(file, {
          delimiter: ';',
          header: true,
          encoding: "UTF-8",
          skipEmptyLines: true,
          complete: function(results) {
            allData = processData(results.data);
            filteredData = [...allData];
            
            gsap.to('#loading', {
              opacity: 0,
              duration: 0.5,
              onComplete: () => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                AOS.refresh();
                
                updateDashboard();
                updateBarChart();
                updatePieChart();
                updateLineChart();
                updateRegionChart();
                updateSectorChart();
                updateTimelineChart();
                // Appliquer le tri par défaut et afficher le tableau
                sortData();
                // Remplir le tableau Budget par Pays
                populateBudgetByCountryTable();
                
                window.scrollTo({ top: document.querySelector('#stats').offsetTop - 100, behavior: 'smooth' });
              }
            });
          },
          error: function(error) {
            console.error('Error:', error);
            document.getElementById('loading').innerHTML = `
              <div class="error-message animate__animated animate__shakeX">
                <i class="fas fa-exclamation-triangle fa-3x" style="color: var(--accent-color); margin-bottom: 15px;"></i>
                <h3>Erreur lors de la lecture du fichier</h3>
                <p>Veuillez vérifier le format du fichier et réessayer.</p>
              </div>
            `;
          }
        });
      }
    });

    // Expose toggleDetails to global scope
    window.toggleDetails = toggleDetails;
  </script>
</body>
</html>
